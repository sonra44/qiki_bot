# Журнал изменений, внесенных Gemini в проект QIKI Bot

Этот файл содержит записи обо всех изменениях, выполненных Gemini в проекте QIKI Bot.

## 2025-07-20

### Cached RuleEngine

*   Переписан `core/rule_engine.py` — правила загружаются один раз и могут быть
    обновлены через `reload_rules()`.
*   Добавлена функция `log_rule_trigger()` для трассировки срабатываний правил.

## 2025-07-19

### Фаза 6: CLI-улучшения (команды: `status`, `agents`, `diagnostics`)

*   **Цель**: Добавление ключевых команд в терминальный интерфейс `operator_interface.py` для удобного мониторинга и диагностики системы.
*   **`qiki_bot/operator_interface.py`**: Модифицирован для включения следующих команд:
    *   **`status`**: Отображает общее состояние FSM, последнюю миссию, последнюю активность и наличие ошибок/предупреждений из логов.
    *   **`agents`**: Выводит список всех агентов из `shared_bus.json`, их `last_heartbeat` (в человекочитаемом виде) и статус (`ALIVE`, `STALE`, `DEAD`).
    *   **`diagnostics`**: Показывает целостность ключевых файлов, результат проверки `system_health_monitor` и сверяет согласованность FSM ↔ сенсоры ↔ миссии.
*   **Поддержка**: Все новые команды используют `localization_manager.py` для двуязычного вывода и логируют результат в `logs/cli_input.log`. Реализован fallback для случаев отсутствия файлов.



### Фаза 4э: TTL / Heartbeat для агентов

*   **Цель**: Добавить механизм отслеживания активности агентов (heartbeat) для определения их статуса (активен, устарел, неактивен).
*   **`core/agent_ping.py`**: Модифицирован для включения поля `last_heartbeat` в `shared_bus.json` с меткой времени UTC ISO 8601 при каждой активности агента.
*   **`tools/system_health_monitor.py`**: Обновлен для проверки `last_heartbeat` каждого агента в `shared_bus.json`.
    *   Агенты считаются `STALE` (устаревшими), если `last_heartbeat` старше 3 секунд.
    *   Агенты считаются `DEAD` (неактивными), если `last_heartbeat` старше 10 секунд.
*   **Логирование**: Статус каждого агента (OK, STALE, DEAD) теперь записывается в `logs/agent_health.log` в удобочитаемом формате.



### Фаза 6: Изоляция доступа к FSM-состоянию

*   **Цель**: Полностью запретить прямой доступ к `fsm_state.json` из любых других частей системы, перенаправив все операции через `core/fsm_client.py`.
*   **`core/fsm_client.py`**: Подтверждено наличие методов `get_state()` и `set_state()`, а также встроенной валидации состояния FSM и логирования ошибок.
*   **Рефакторинг модулей**:
    *   `core/fsm_interface.py`: Обновлен для использования `FSMClient` для загрузки и сохранения состояния FSM.
    *   `core/fsm_gatekeeper.py`: Обновлен для использования `FSMClient` через `FSMInterface`, удален прямой аргумент `fsm_state_file`.
    *   `simulation/physics_engine.py`: Обновлен для использования `FSMClient` для получения состояния FSM и удален прямой вызов `os.remove(FSM_STATE_FILE)`.
    *   `status_hud.py`: Исправлена ошибка с неопределенной переменной `fsm_data`, заменена на `fsm.get("mode")`.
    *   `state_monitor.py`: Исправлена ошибка с неопределенной переменной `fsm_data`, заменена на `fsm.get("mode")`.
*   **Проверка прямых обращений**: Проведен тщательный поиск, подтвердивший отсутствие прямых вызовов `open('fsm_state.json')` в кодовой базе, за исключением файлов промптов.
*   **`core/fsm_io.py`**: Подтверждено, что данный модуль не взаимодействует напрямую с `fsm_state.json` и не требует изменений.



### Фаза 5: Создание модуля проверки согласованности системы

*   **`tools/consistency_checker.py`**: Создан новый фоновый модуль для непрерывной проверки логической согласованности между `fsm_state.json`, `sensors.json`, `telemetry.json` и `mission_status.json`.
*   **Логирование несоответствий**: Все обнаруженные аномалии и ошибки записываются в `logs/consistency_log.json`, а критические сбои — в `logs/qiki_crash.log`.
*   **Гибкий запуск**: Модуль поддерживает запуск в режиме однократной проверки (`--once`) или постоянного мониторинга (`--watch`), а также подробный вывод в консоль (`--verbose`).
*   **`mission_status.json`**: Создан файл-плейсхолдер для отслеживания статуса миссий, который используется новым модулем проверки.

### Фаза 4: Архитектурное разделение FSM на ядро и интерфейс

*   **`core/fsm_core.py`**: Логика конечного автомата была переработана и вынесена в класс `FiniteStateMachine`, который теперь является "чистым" и не зависит от операций ввода-вывода.
*   **`core/fsm_interface.py`**: Создан новый модуль-интерфейс, который инкапсулирует `fsm_core.py` и управляет всем взаимодействием с файловой системой (`fsm_state.json`). Это обеспечивает четкое разделение логики и I/O.
*   **`core/fsm_gatekeeper.py`**: Основной процесс-хранитель состояний был обновлен для использования нового `fsm_interface.py`, что упростило его код и повысило надежность.
*   **`core/fsm_io.py`**: Модуль был значительно упрощен и теперь отвечает только за одну задачу: постановку событий в очередь `fsm_requests.json`.
*   **`core/fsm_client.py`**: Клиентский модуль для чтения состояния FSM был переписан для прямого и безопасного чтения `fsm_state.json` с использованием файловых блокировок, устраняя зависимость от кэша.
*   **`tools/fsm_debugger.py`**: Добавлен новый CLI-инструмент для отладки FSM, позволяющий просматривать статус, инициировать события и проверять возможные переходы.

### Фаза 3: Оптимизация I/O через RAM-кэш

*   **`core/shared_json_cache.py`**: Создан новый потокобезопасный, синглтон-модуль для кэширования ключевых JSON-файлов в оперативной памяти. Он использует фоновый поток для отслеживания изменений файлов и автоматического обновления кэша, что кардинально снижает нагрузку на файловую систему.
*   **`tools/json_cache_debugger.py`**: Создан CLI-инструмент для интерактивной отладки и мониторинга состояния RAM-кэша.
*   **Интеграция с FSM**: Модули `core/fsm_io.py` и `core/fsm_client.py` были обновлены для использования `shared_json_cache`, что значительно ускорило операции чтения и записи состояния FSM.
*   **Интеграция с CLI**: Модули-дашборды, такие как `status_hud.py` и `state_monitor.py`, теперь получают данные из кэша, что обеспечивает более плавное и быстрое обновление интерфейса.

### Фаза 2: Создание системного валидатора целостности

*   **`tools/consistency_checker.py`**: Создан новый фоновый модуль для непрерывной проверки логической согласованности между состоянием FSM, телеметрией и статусом миссий.
*   **Логирование целостности**: Все обнаруженные аномалии и ошибки теперь записываются в `logs/system_integrity.log`.
*   **CLI-интерфейс**: Скрипт поддерживает запуск в однократном (`--once`) и непрерывном (`--watch`) режимах.
*   **`mission_status.json`**: Создан файл-плейсхолдер для отслеживания статуса миссий, который будет использоваться валидатором.

### Фаза 1: Рефакторинг и изоляция FSM (конечного автомата)

*   **`core/fsm_core.py`**: Создан новый модуль, содержащий исключительно логику переходов состояний FSM без какого-либо файлового ввода-вывода. Это делает ядро FSM полностью тестируемым в изоляции.
*   **`core/fsm_io.py`**: Создан новый модуль, который инкапсулирует все операции чтения/записи в `fsm_state.json`. Он предоставляет высокоуровневый API (`get_current_state`, `trigger_event`, `enqueue_event`) для взаимодействия с FSM, реализует кэширование и атомарное сохранение состояния.
*   **`core/fsm_client.py`**: Создан новый клиентский модуль, предоставляющий безопасный (read-only) доступ к состоянию FSM для модулей мониторинга.
*   **`core/fsm_gatekeeper.py`**: Модуль полностью переписан для использования `fsm_io.py` и `fsm_core.py`. Теперь он отвечает только за обработку очереди запросов, а не за логику FSM или файловые операции.
*   **`core/fsm.py`**: Старый модуль FSM, смешивавший логику и I/O, был удален.
*   **Модули-мониторы (`status_hud.py`, `state_monitor.py`, `voice_logger.py` и др.)**: Обновлены для использования `core/fsm_client.py` вместо прямого чтения `fsm_state.json`.
*   **`tests/test_fsm_core.py`**: Добавлен новый unit-тест для проверки логики `FSMCore` в полностью изолированной среде. Тесты успешно пройдены.

## 2025-07-18

### Фаза 1: Интеграция терминального кокпита

*   **`interfaces/cli/agent_monitor.py`**: Полностью переработан для отображения нового, стилизованного в NASA-стиле, терминального кокпита. Старый интерфейс мониторинга агентов заменен на статический ASCII-дашборд, который будет подключен к реальным данным и локализован на следующем этапе. Интеграция выполнена в соответствии с высокоточным промптом, полученным от пользователя.

## 2025-07-15

### Фаза 1: Адаптация CLI-модулей к новой структуре сенсорных данных

*   **`status_hud.py`**: Адаптирован для использования `sensors.communication.signal_strength_meters.rssi` вместо `sensors.communication.signal_strength.rssi`.
*   **`navigation_monitor.py`**: Адаптирован для использования `sensors.navigation.imu` и `sensors.navigation.gyroscope` вместо плоской структуры.
*   **`sensor_overlay.py`**: Адаптирован для использования `sensors.navigation.imu` вместо плоской структуры.
*   **`state_monitor.py`**: Адаптирован для использования `sensors.navigation.imu.accel_z` и `sensors.navigation.gyroscope.yaw_rate` для проверки аномалий.
*   **`tools/system_health_monitor.py`**: Адаптирован для использования `sensors.communication.signal_strength_meters.rssi` для проверки связи.
*   **`tools/system_monitor.py`**: Адаптирован для использования `sensors.communication.signal_strength_meters.rssi` и других иерархических путей для отображения сенсоров.
*   **`interfaces/cli/cli_dashboard.py`**: Адаптирован для рекурсивного отображения иерархической структуры `sensors.json`.
*   **`interfaces/cli/system_dashboard.py`**: Добавлена отсутствующая логика отображения и адаптирован доступ к иерархической структуре `sensors.json`.

### Фаза 2: Централизация работы с FSM

*   **`operator_interface.py`**: Изменено использование прямой записи в `fsm_requests.json` на использование `core.fsm_client.send_event()`.
*   **`event_trigger.py`**: Изменено прямое взаимодействие с `SimpleFSM` на использование `core.fsm_client.send_event()`.

### Фаза 3: Актуализация `rules.json`

*   **`config/rules.json`**: Правило `HighTemperature` изменено с `sensors.thermo_cam > 300` на `sensors.thermal.core_temp.cpu > 85` для соответствия новой структуре сенсоров.

### Фаза 4: Исправление `agent_monitor.py`

*   **`interfaces/cli/agent_monitor.py`**: Адаптирован для корректной обработки фактической структуры `shared_bus.json` (словарь агентов по ID, а не список вложенных агентов).

### Фаза 5: Исправление инициализации `sensors.json`

*   **`tools/agent_initializer.py`**: Изменена инициализация `sensors.json` с плоской структуры на полную иерархическую структуру со всеми кластерами.

### Фаза 6: Актуализация тестов

*   **`tests/test_config_loader.py`**: Удален как устаревший и неиспользуемый.
*   **`tests/test_fsm.py`**: Исправлено имя класса FSM с `QikiFSM` на `SimpleFSM`.
*   **`tests/test_telemetry_cycle.py`**: Удалена проверка наличия ключа `fsm_state` в `telemetry.json`, так как он там не должен находиться.

### Фаза 7: Очистка проекта от устаревших или дублирующих компонентов

*   **`qiki_bot/errors`**: Удален устаревший лог-файл веб-сервера.
*   **`qiki_bot/templates/index.html`**: Удален устаревший шаблон веб-интерфейса.
*   **`qiki_world/visualizers/`, `qiki_world/io_bridge/`, `qiki_world/scene_engine/object_map.py`, `qiki_world/scene_engine/scene_builder.py`**: Проверено, что эти файлы/директории отсутствуют (вероятно, были удалены ранее).
*   **`qiki_bot/PROJECT_MANIFEST.md`**: Удален как дублирующий файл документации.
*   **`qiki_bot/system_logical_analitics`**: Удален как дублирующий файл документации.

### Фаза 8: Обновление `run_all.sh`

*   **`run_all.sh`**: Добавлено логирование запуска каждого фонового Python-модуля.

### Восстановление файлов

*   **`промт`**: Файл был пересоздан с корректным содержимым после обнаружения повреждения кодировки.
*   **`промт.md`**: Файл `промт` был переименован в `промт.md`.
